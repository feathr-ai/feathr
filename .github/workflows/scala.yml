name: Feathr Scala Tests And Azure E2E Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 8
      uses: actions/setup-java@v2
      with:
        java-version: '8'
        distribution: 'temurin'
    - name: Run tests
      run: sbt test
    - name: Build JAR
      run: sbt assembly
    - name: Azure Blob Storage Upload (Overwrite)
      uses: fixpoint/azblob-upload-artifact@v4
      with:
        connection-string: ${{secrets.SPARK_JAR_BLOB_CONNECTION_STRING}}
        name: 'feathr_jar_github_action'
        path: 'target/scala-2.12/feathr-assembly-0.1.0-SNAPSHOT.jar'
        container: ${{secrets.SPARK_JAR_BLOB_CONTAINER}}
        cleanup: 'true'
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install flake8 pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    - name: Install Feathr Package
      run: |
        python -m pip install -e ./feathr_project/
    - name: Test with pytest
      env:
        PROJECT_NAME: "feathr_ci_project"
        FEATHR_RUNTIME_LOCATION: 'abfss://${{secrets.SPARK_JAR_BLOB_CONTAINER}}@feathrazuretest3storage.dfs.core.windows.net/feathr_jar_github_action_spark3/feathr-assembly-0.1.0-SNAPSHOT.jar'
        REDIS_PASSWORD: ${{secrets.REDIS_PASSWORD}}
        AZURE_CLIENT_ID: ${{secrets.AZURE_CLIENT_ID}}
        AZURE_TENANT_ID: ${{secrets.AZURE_TENANT_ID}}
        AZURE_CLIENT_SECRET: ${{secrets.AZURE_CLIENT_SECRET}}
        S3_ACCESS_KEY: ${{secrets.S3_ACCESS_KEY}}
        S3_SECRET_KEY: ${{secrets.S3_SECRET_KEY}}

      run: |        
        cd feathr_project
        pytest